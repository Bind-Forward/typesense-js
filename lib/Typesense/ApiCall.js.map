{"version":3,"sources":["Typesense/ApiCall.js"],"names":["APIKEYHEADERNAME","HEALTHY","UNHEALTHY","ApiCall","configuration","_configuration","_apiKey","apiKey","_nodes","nodes","_connectionTimeoutSeconds","connectionTimeoutSeconds","_healthcheckIntervalSeconds","healthcheckIntervalSeconds","_numRetriesPerRequest","numRetries","_retryIntervalSeconds","retryIntervalSeconds","_logger","logger","_initializeMetadataForNodes","_currentNodeIndex","endpoint","parameters","performRequest","undefined","requestType","queryParameters","bodyParameters","additionalHeaders","validate","debug","toUpperCase","numTries","node","_updateCurrentNode","index","requestOptions","method","url","_uriFor","headers","Object","assign","_defaultHeaders","params","data","timeout","validateStatus","status","transformResponse","transformedData","startsWith","JSON","parse","response","_setNodeHealthcheck","Promise","resolve","reject","Error","request","path","message","lastException","warn","stringify","_timer","map","isHealthy","join","candidateNodeIndex","i","length","_resetNodeHealthcheckIfExpired","Date","now","lastHealthcheckTimestamp","forEach","nodeIndex","protocol","host","port","defaultHeaders","seconds","setTimeout","module","exports"],"mappings":"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","sourcesContent":["'use strict'\nimport axios from 'axios'\n\nconst APIKEYHEADERNAME = 'X-TYPESENSE-API-KEY'\nconst HEALTHY = true\nconst UNHEALTHY = false\n\nclass ApiCall {\n  constructor (configuration) {\n    this._configuration = configuration\n\n    this._apiKey = this._configuration.apiKey\n    this._nodes = [...this._configuration.nodes] // Make a copy, since we'll be adding additional metadata to the nodes\n    this._connectionTimeoutSeconds = this._configuration.connectionTimeoutSeconds\n    this._healthcheckIntervalSeconds = this._configuration.healthcheckIntervalSeconds\n    this._numRetriesPerRequest = this._configuration.numRetries\n    this._retryIntervalSeconds = this._configuration.retryIntervalSeconds\n\n    this._logger = this._configuration.logger\n\n    this._initializeMetadataForNodes()\n    this._currentNodeIndex = -1\n  }\n\n  get (endpoint, parameters = {}) {\n    return this.performRequest('get', endpoint, parameters)\n  }\n\n  delete (endpoint, parameters = {}) {\n    return this.performRequest('delete', endpoint, parameters)\n  }\n\n  post (endpoint, parameters = {}) {\n    return this.performRequest('post', endpoint, undefined, parameters)\n  }\n\n  put (endpoint, parameters = {}) {\n    return this.performRequest('put', endpoint, undefined, parameters)\n  }\n\n  async performRequest (requestType, endpoint, queryParameters = {}, bodyParameters = {}, additionalHeaders = {}) {\n    this\n      ._configuration\n      .validate()\n\n    let lastException\n\n    this._logger.debug(`Performing ${requestType.toUpperCase()} request: ${endpoint}`)\n    for (let numTries = 1; numTries <= this._numRetriesPerRequest + 1; numTries++) {\n      let node = this._updateCurrentNode()\n      this._logger.debug(`Attempting ${requestType.toUpperCase()} request Try #${numTries} to Node ${node.index}`)\n      try {\n        const requestOptions = {\n          method: requestType,\n          url: this._uriFor(endpoint, node.index),\n          headers: Object.assign({}, this._defaultHeaders(), additionalHeaders),\n          params: queryParameters,\n          data: bodyParameters,\n          timeout: this._connectionTimeoutSeconds * 1000,\n          validateStatus: (status) => {\n            /* Override default validateStatus, which only considers 2xx a success.\n                In our case, anything below 500 should be considered a \"success\" and not retried.\n                We will handle anything not 2xx, but below 500 as a custom exception below.\n             */\n            return status > 0 && status < 500\n          },\n          transformResponse: [(data, headers) => {\n            let transformedData = data\n            if (headers['content-type'].startsWith('application/json') && typeof data === 'string') {\n              transformedData = JSON.parse(data)\n            }\n            return transformedData\n          }]\n        }\n\n        let response = await axios(requestOptions)\n        this._setNodeHealthcheck(node, HEALTHY)\n\n        this._logger.debug(`Request to Node ${node.index} was successfully made. Response Code was ${response.status}.`)\n\n        // If response is 2xx return a resolved promise, else reject\n        if (response.status >= 200 && response.status < 300) {\n          return Promise.resolve(response.data)\n        } else {\n          return Promise.reject(new Error(`${response.request.path} - ${response.data.message}`))\n        }\n      } catch (error) {\n        // This block handles HTTPStatus < 0, HTTPStatus > 500 and network layer issues like connection timeouts\n        this._setNodeHealthcheck(node, UNHEALTHY)\n        lastException = error\n        this._logger.warn(`Request to Node ${node.index} failed due to \"${error.message}${error.response == null ? '' : ' - ' + JSON.stringify(error.response.data)}\"`)\n        this._logger.warn(`Sleeping for ${this._retryIntervalSeconds}s and then retrying request...`)\n        await this._timer(this._retryIntervalSeconds)\n      }\n    }\n    this._logger.debug(`No retries left. Raising last error`)\n    return Promise.reject(lastException)\n  }\n\n  _updateCurrentNode () {\n    this._logger.debug(`Nodes Health: ${this._nodes.map(node => `Node ${node.index} is ${node.isHealthy === true ? 'Healthy' : 'Unhealthy'}`).join(' || ')}`)\n    let candidateNodeIndex = this._currentNodeIndex\n    for (let i = 0; i <= this._nodes.length; i++) {\n      candidateNodeIndex = (candidateNodeIndex + 1) % this._nodes.length\n      this._resetNodeHealthcheckIfExpired(this._nodes[candidateNodeIndex])\n      if (this._nodes[candidateNodeIndex].isHealthy === true) {\n        break\n      }\n      if (i === this._nodes.length) {\n        this._logger.debug(`No healthy nodes were found. Returning the next node, Node ${candidateNodeIndex}`)\n      }\n    }\n    this._logger.debug(`Updated current node to Node ${candidateNodeIndex}`)\n    this._currentNodeIndex = candidateNodeIndex\n    return this._nodes[candidateNodeIndex]\n  }\n\n  _resetNodeHealthcheckIfExpired (node) {\n    // this._logger.debug(`Checking if Node ${node.index} healthcheck needs to be reset`)\n    if (node.isHealthy === true || Date.now() - node.lastHealthcheckTimestamp < (this._healthcheckIntervalSeconds * 1000)) {\n      // this._logger.debug(`Healthcheck reset not required for Node ${node.index}. It is currently marked as ${node.isHealthy === true ? 'Healthy' : 'Unhealthy'}. Difference between current time and last healthcheck timestamp is ${Date.now() - node.lastHealthcheckTimestamp}`)\n      return null\n    }\n\n    this._logger.debug(`Node ${node.index} has exceeded healthcheckIntervalSeconds of ${this._healthcheckIntervalSeconds}s. Adding it back into rotation.`)\n    this._setNodeHealthcheck(node, HEALTHY)\n    this._logger.debug(`Nodes Health: ${this._nodes.map(node => `Node ${node.index} is ${node.isHealthy === true ? 'Healthy' : 'Unhealthy'}`).join(' || ')}`)\n  }\n\n  _initializeMetadataForNodes () {\n    this._nodes.forEach((node, i) => {\n      node.index = i\n      this._setNodeHealthcheck(node, HEALTHY)\n    })\n  }\n\n  _setNodeHealthcheck (node, isHealthy) {\n    node.isHealthy = isHealthy\n    node.lastHealthcheckTimestamp = Date.now()\n  }\n\n  _uriFor (endpoint, nodeIndex = this._currentNodeIndex) {\n    return `${this._nodes[nodeIndex].protocol}://${this._nodes[nodeIndex].host}:${this._nodes[nodeIndex].port}${this._nodes[nodeIndex].path}${endpoint}`\n  }\n\n  _defaultHeaders () {\n    let defaultHeaders = {}\n    defaultHeaders[APIKEYHEADERNAME] = this._apiKey\n    // TODO: Might need to update this for import endpoint, since it requires non-json\n    defaultHeaders['Content-Type'] = 'application/json'\n    return defaultHeaders\n  }\n\n  async _timer (seconds) {\n    return new Promise(resolve => setTimeout(resolve, seconds * 1000))\n  }\n}\n\nmodule.exports = ApiCall\n"],"file":"ApiCall.js"}